---
title: "{dm} and databases"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{{dm} and databases}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
fansi::set_knit_hooks(knitr::knit_hooks)
options(crayon.enabled = TRUE, width = 75, cli.width = 75)

knit_print.grViz <- function(x, ...) {
  x %>% 
    DiagrammeRsvg::export_svg() %>% 
    c("`````{=html}\n", ., "\n`````\n") %>% 
    knitr::asis_output()
}
```

{dm} integrates well into {dbplyr} workflows — however, currently it only supports MSSQL and Postgres DBMS — more are planned for future releases.

<!-- Relevant functions for interaction with DBs: -->

<!-- - `cdm_copy_to()` -->
<!-- - `cdm_set_key_constraints()` -->
<!-- - `cdm_learn_from_db()` -->

# Setting up the example

In order to work with a databases, you first need to connect to one.
We'll use a local Postgres database for this.

This requires you to have the PostgreSQL driver installed and activated (see install guides for [Mac OS X](https://www.robinwieruch.de/postgres-sql-macos-setup/), [Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-18-04), [Windows](https://www.microfocus.com/documentation/idol/IDOL_12_0/MediaServer/Guides/html/English/Content/Getting_Started/Configure/_TRN_Set_up_PostgreSQL.htm)). Also see this [Stackoverflow question](https://stackoverflow.com/questions/17633422/psql-fatal-database-user-does-not-exist) if you get the error `psql: FATAL: database “<user>” does not exist`. 

First, we connect to the default Postgres database.

```{r}
library(dm)
library(DBI)
library(dbplyr)
con <- dbConnect(RPostgres::Postgres())
```

# Getting {dm} objects into a database using `cdm_copy_to`

Next, we'll copy the built-in example {dm} object `cdm_nycflights13()` to this database.

```{r}
cdm_copy_to(dest = con, dm = cdm_nycflights13())
```

If we call up the object `con` now, we'll see that we've added the new tables:

```{r}
RPostgres::dbListTables(con)
```

# Learning from databases — `cdm_learn_from_db ()`

Having copied some tables to the database above, we can do the reverse operation: 

```{r}
# cdm_learn_from_db(con) # not sure why this wouldn't work, but it doesn't
src_postgres() %>% 
  cdm_learn_from_db()
```

+++ add example here where the contents of a DB are not yet a {dm} object.
For example using the equivalent of `dbplyr::lahman_sqlite()`, `dbplyr::lahman_postgres()` does not appear to be working for some reason (see s [currently unanswered Stackoverflow question](https://stackoverflow.com/questions/57290681/rs-dbi-driver-could-not-connect-userlocalhost5432-on-dbname-lahman-fatal)). +++ 

# Setting key constraints - `cdm_set_key_constraints()`

`cdm_set_key_constraints()` takes a dm object that lives in a DB and mirrors the dm key constraints on the database. [text from function help page — I don't know if I get what this does].

This means that the information you've provided to {dm} about primary keys and foreign keys is transferred to the database. 
In other words, upon applying `cdm_set_key_constraints()`, the database will also be aware about information such as:
- whether a certain column is a primary key
- if a column type cannot be NULL
- if a certain column serves as a foreign key to other tables

In order to do so, you need to set the appropriate option when transferring data to the database:

```{r}
cdm_copy_to(
  dest = con, 
  dm = cdm_nycflights13(), 
  set_key_constraints = TRUE
  )
```

<!-- --- -->
<!-- <!-- using rsqlite instead  --> -->

<!-- ```{r} -->
<!-- con <- dbConnect(RSQLite::SQLite(), ":memory:") -->
<!-- cdm_copy_to(dest = con, dm = cdm_nycflights13()) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- cdm_learn_from_db(con) -->

<!-- cdm_learn_from_db() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- library(dplyr) -->
<!-- src_sqlite <- src_sqlite(":memory:", create = TRUE) -->
<!-- src_sqlite -->
<!-- nycflights13_remote <- cdm_copy_to(src_sqlite, cdm_nycflights13(cycle = TRUE)) -->
<!-- nycflights13_remote -->
<!-- src_postgres <- src_postgres() -->
<!-- nycflights13_from_remote <- cdm_learn_from_db(nycflights13_remote) -->

<!-- ``` -->
