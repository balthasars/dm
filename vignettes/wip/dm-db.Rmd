---
title: "{dm} and databases"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{{dm} and databases}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
fansi::set_knit_hooks(knitr::knit_hooks)
options(crayon.enabled = TRUE, width = 75, cli.width = 75)

knit_print.grViz <- function(x, ...) {
  x %>% 
    DiagrammeRsvg::export_svg() %>% 
    c("`````{=html}\n", ., "\n`````\n") %>% 
    knitr::asis_output()
}
```

{dm} is at its most powerful you use it with databases — integration with {dbplyr} workflows with MSSQL and Postgres DBMS is easy as pie (full support for more databases will follow in future versions).

<!-- Relevant functions for interaction with DBs: -->

<!-- - `cdm_copy_to()` -->
<!-- - `cdm_set_key_constraints()` -->
<!-- - `cdm_learn_from_db()` -->

# Setting up the example

In order to work with a databases, you first need to connect to one.
We'll use a local Postgres database for this.

This requires you to have the PostgreSQL driver installed and activated (see install guides for [Mac OS X](https://www.robinwieruch.de/postgres-sql-macos-setup/), [Ubuntu 18.04](https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-ubuntu-18-04), [Windows](https://www.microfocus.com/documentation/idol/IDOL_12_0/MediaServer/Guides/html/English/Content/Getting_Started/Configure/_TRN_Set_up_PostgreSQL.htm)). Also see this [Stackoverflow question](https://stackoverflow.com/questions/17633422/psql-fatal-database-user-does-not-exist) if you get the error `psql: FATAL: database “<user>” does not exist`. 

Let's connect to the default Postgres database. 

We'll do so here using {DBI}:

```{r}
library(magrittr)
library(dm)
library(dplyr)
library(DBI)
con <- dbConnect(RPostgres::Postgres())
```

```{r}
dbListTables(con)
#   purrr::map(dbRemoveTable, conn = con)
# dbRemoveTable(con, "AwardsPlayers")
```

# Getting {dm} objects into a database using `cdm_copy_to`

Next, we'll copy the built-in example {dm} object `cdm_nycflights13()` to this database.

```{r eval = FALSE}
# cdm_copy_to(dest = con, dm = cdm_nycflights13())

remote_dm <- cdm_copy_to(
  con, 
  dm = cdm_nycflights13(), 
  set_key_constraints = FALSE, 
  temporary = TRUE
  )

collect(remote_dm)
```

```{r}
remote_src <- dm:::src_from_src_or_con(con)
remote_dm <- 
  cdm_copy_to(
  remote_src, 
  dm = cdm_nycflights13(), 
  set_key_constraints = FALSE, 
  temporary = TRUE
  )
remote_dm %>% collect()
```


If we call up the object `con` now, we'll see that we've added the new tables:

```{r}
RPostgres::dbListTables(con) %>% 
  as_tibble()
```

# Learning from databases — `cdm_learn_from_db ()`

Having copied some tables to the database above, we can do the reverse operation: 

```{r}
cdm_learn_from_db(con) 
src_postgres() %>% 
  cdm_learn_from_db()

id <- Id(Schema = "information_schema", table = "tables")
dbReadTable(con, id) %>% as_tibble()
```

# Setting key constraints - `cdm_set_key_constraints()`

`cdm_set_key_constraints()` takes a dm object that lives in a DB and mirrors the dm key constraints on the database. [text from function help page — I don't know if I get what this does].

This means that the information you've provided to {dm} about primary keys and foreign keys is transferred to the database. 
In other words, upon applying `cdm_set_key_constraints()`, the database will also be aware about information such as:
- whether a certain column is a primary key
- if a column type cannot be NULL
- if a certain column serves as a foreign key to other tables

In order to do so, you need to set the appropriate option when transferring data to the database:

```{r}
cdm_copy_to(
  dest = con, 
  dm = cdm_nycflights13(), 
  set_key_constraints = TRUE
  )
```

# `collect()`

`collect()` provides a method to retrieve tables from a database and saves them  a {dm} object.

```{r}
dbListTables(con)
```


<!-- --- -->
<!-- <!-- using rsqlite instead  --> -->

<!-- ```{r} -->
<!-- con <- dbConnect(RSQLite::SQLite(), ":memory:") -->
<!-- cdm_copy_to(dest = con, dm = cdm_nycflights13()) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- cdm_learn_from_db(con) -->

<!-- cdm_learn_from_db() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- library(dplyr) -->
<!-- src_sqlite <- src_sqlite(":memory:", create = TRUE) -->
<!-- src_sqlite -->
<!-- nycflights13_remote <- cdm_copy_to(src_sqlite, cdm_nycflights13(cycle = TRUE)) -->
<!-- nycflights13_remote -->
<!-- src_postgres <- src_postgres() -->
<!-- nycflights13_from_remote <- cdm_learn_from_db(nycflights13_remote) -->

<!-- ``` -->
